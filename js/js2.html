<head>

<script>
compteur=0;
function traiter() {
	console.log("traiter : " + ++compteur); 
}
function traiter2() {
	console.log("traiter2 : " + ++compteur); 
}
function poursuivre() {
	if (compteur<=5) return true;
	else return false;
}
//boucle(5,traiter,poursuivre); 
//boucle(2,traiter2); 

/* 
// Ne fonctionne que Pour une seule boucle à la fois 
// car on utilise des var. globales !! 
var g_iPeriode;
var g_fnCbTraitement;
var g_fnCbContinuer;
function boucle(iPeriode,fnCbTraitement,fnCbContinuer) {

	if (iPeriode != undefined) {
		// premiere fois : on stocke les arguments en var. globales 
		g_iPeriode = iPeriode; 
		g_fnCbTraitement = fnCbTraitement;
		g_fnCbContinuer = fnCbContinuer;
	}

	if (g_fnCbContinuer()) {
		g_fnCbTraitement();
		setTimeout(boucle, g_iPeriode*1000);
	}

	// Objectif : déclencher un appel à la fonction fnCbTraitement
	// toutes les iPeriode secondes, 
	// tant que fnCbContinuer renvoie vrai
	
	// OBLIGATION d'utiliser window.setTimeout
	// IL FAUT POUVOIR DECLENCHER PLUSIEURS BOUCLES en parallèle 
	// => impossible de stocker de l'information en var. globale 
	// INTERDICTION d'utiliser les arguments optionnels de setTimeout
	// setTimeout(functionRef, delay) seulement 

	// fnCbTraitement est une fonction de rappel ("CALLBACK")
	// elle sera appelée plus tard
	// pour l'appeler, il suffit d'ajouter les parenthèses !

	// rendre le 3ème argument optionnel

}
*/
/*
function boucle(iPeriode,fnCbTraitement,fnCbContinuer) {

	// TODO : enfermer dans le scope de la fonction à rappeler
	// plutôt que dans des variables globales 
	// les informations de rappel 
	
	if ( (fnCbContinuer == undefined) || fnCbContinuer()) {
		fnCbTraitement();
		setTimeout(function() {
			boucle(iPeriode,fnCbTraitement,fnCbContinuer); 
		}, iPeriode*1000);
	}
}*/

function boucle(iPeriode,fnCbTraitement,fnCbContinuer) {

	// TODO : enfermer dans le scope de la fonction à rappeler
	// plutôt que dans des variables globales 
	// les informations de rappel 
	
	var foo = function () {
		// la fonction "voit" les paramètres formels de boucle !! 
		if ( (fnCbContinuer == undefined) || fnCbContinuer()) {
			fnCbTraitement();
			setTimeout(foo, iPeriode*1000);
		}
	}; 
	foo();
}

// TODO : rendre tous les arguments optionnels ! 
// Solution : passer un objet de configuration en paramètre

var oDefault = {
	periode : 5, 
	fnTraitement : function(){console.log("traitement");}, 
	fnPoursuite: function(){return true;}
}

// TODO : fabriquer une fonction enrichir(oDefault,oParams) 
// qui effectue une clonage superficiel de la structure oDefault
// en utilisant des données (si elles existent) de oParams
// et renvoie donc un nouvel objet ! 

function enrichir(oDefault,oParams) {
	var res = {}; 
	var prop; 
	
	for (prop in oDefault) {
		if 		 ((oParams != undefined) 
				&& (oParams[prop] != undefined))
			res[prop] = oParams[prop]; 
		else
			res[prop] = oDefault[prop];
	}

	return res; 
}

function oBoucle(oConfig) {
	/*
	var oEffectif = oDefault; // ceci est une prise de référence ! 
	// On préfèrerait un clonage !! 
	// https://www.younup.fr/blog/le-clonage-des-objets-en-js
	// const newRobot = JSON.parse(JSON.stringify(complexRobot));
	// ne permet pas de traiter les fonctions 
	// JS6 assign : superficiel
	// Jquery : .clone() peut faire du deep clone 
	// clonage superficiel : on duplique la structure de l'objet 
	// on garde les valeurs de l'objet initial 
	// parmi ces valeurs, il peut y avoir des références qui persistent dans l'objet cloné 
	
	if (oConfig.periode != undefined) 
		oEffectif.periode = oConfig.periode; 
		
	if (oConfig.fnTraitement != undefined) 
		oEffectif.fnTraitement = oConfig.fnTraitement; 
		
	if (oConfig.fnPoursuite != undefined) 
		oEffectif.fnPoursuite = oConfig.fnPoursuite; 
	*/
	
	var oEffectif = enrichir(oDefault,oConfig);
	
	var foo = function () {
		if (oEffectif.fnPoursuite()) {
			oEffectif.fnTraitement();
			setTimeout(foo, oEffectif.periode*1000);
		}
	}; 
	foo();
}

oBoucle({periode:2}); 
oBoucle({});
oBoucle({fnTraitement:traiter});
oBoucle({fnTraitement:traiter2, fnPoursuite:poursuivre}); 
oBoucle();

</script>
</head>
<body>


</body>










